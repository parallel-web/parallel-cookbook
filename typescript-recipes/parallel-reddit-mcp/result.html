<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change My Mind - Debate Result</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
        @font-face {
            font-family: 'FT System Mono';
            src: url('https://assets.p0web.com/FTSystemMono-Regular.woff2') format('woff2');
            font-weight: 400;
            font-display: swap;
        }

        @font-face {
            font-family: 'FT System Mono';
            src: url('https://assets.p0web.com/FTSystemMono-Medium.woff2') format('woff2');
            font-weight: 500;
            font-display: swap;
        }

        @font-face {
            font-family: 'FT System Mono';
            src: url('https://assets.p0web.com/FTSystemMono-Bold.woff2') format('woff2');
            font-weight: 700;
            font-display: swap;
        }

        @font-face {
            font-family: 'Gerstner Programm';
            src: url('https://assets.p0web.com/Gerstner-ProgrammRegular.woff2') format('woff2');
            font-weight: 400;
            font-display: swap;
        }

        @font-face {
            font-family: 'Gerstner Programm';
            src: url('https://assets.p0web.com/Gerstner-ProgrammMedium.woff2') format('woff2');
            font-weight: 500;
            font-display: swap;
        }

        :root {
            --off-white: #fcfcfa;
            --index-black: #1d1b16;
            --neural: #d8d0bf;
            --signal: #fb631b;
        }

        body {
            font-family: 'FT System Mono', monospace;
            background-color: var(--off-white);
            color: var(--index-black);
        }

        .gerstner {
            font-family: 'Gerstner Programm', serif;
        }

        .meme-container {
            position: relative;
            background-image: url('/change-my-mind.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            aspect-ratio: 950/960;
            max-width: 400px;
        }

        .meme-text {
            position: absolute;
            top: 60%;
            bottom: 20%;
            left: 30%;
            right: 15%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Impact', 'Arial Black', sans-serif;
            font-weight: 900;
            color: black;
            text-align: center;
            text-transform: uppercase;
            font-size: clamp(12px, 2.5vw, 18px);
            line-height: 1.1;
            text-shadow: 2px 2px 0px white, -2px -2px 0px white, 2px -2px 0px white, -2px 2px 0px white;
            padding: 4px;
        }

        .neural-bg {
            background-color: var(--neural);
        }

        .signal-text {
            color: var(--signal);
        }

        .index-black-text {
            color: var(--index-black);
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .citation-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background-color: var(--signal);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 700;
            text-decoration: none;
            margin-left: 4px;
            transition: all 0.2s ease;
        }

        .citation-icon:hover {
            background-color: var(--index-black);
            transform: scale(1.1);
        }

        .sources-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e5e7eb;
        }

        .source-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 0;
        }

        .source-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background-color: var(--signal);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .source-link {
            color: var(--signal);
            text-decoration: none;
            font-weight: 500;
            word-break: break-all;
            overflow-wrap: break-word;
            hyphens: auto;
            display: block;
            line-height: 1.4;
        }

        .source-link:hover {
            text-decoration: underline;
        }

        .excerpt {
            font-style: italic;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .mcp-stats {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border: 1px solid #d1d5db;
        }

        .mcp-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background-color: var(--signal);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tool-call-item {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .tool-call-header {
            display: flex;
            align-items: center;
            justify-content: between;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .tool-name {
            font-weight: 600;
            color: var(--index-black);
        }

        .server-name {
            color: var(--signal);
            font-size: 0.875rem;
        }

        .tool-content {
            font-size: 0.875rem;
            color: #6b7280;
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }

        .tool-content::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 20px;
            width: 100%;
            background: linear-gradient(transparent, white);
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- Header -->
    <header class="p-6 border-b border-gray-200">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <img src="https://assets.p0web.com/dark-parallel-symbol-270.svg" alt="Parallel" class="w-8 h-8">
                <a href="/" class="gerstner text-2xl font-medium hover:text-gray-600">Change My Mind</a>
            </div>
            <a href="/" class="text-sm text-gray-600 hover:text-gray-800">‚Üê Back to debates</a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="py-12 px-6">
        <div class="max-w-4xl mx-auto">

            <!-- Meme Section -->
            <div class="text-center mb-12">
                <div class="meme-container mx-auto mb-6">
                    <div class="meme-text" id="meme-statement">
                        <!-- Statement will be injected here -->
                    </div>
                </div>

                <!-- Author Info -->
                <div class="flex items-center justify-center space-x-3 mb-8">
                    <img id="author-avatar" src="" alt="" class="w-10 h-10 rounded-full">
                    <div class="text-left">
                        <div class="font-medium" id="author-name"></div>
                        <div class="text-sm text-gray-600" id="debate-date"></div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-16 hidden">
                <div
                    class="loading-spinner w-12 h-12 border-4 border-gray-300 border-t-black rounded-full mx-auto mb-6">
                </div>
                <h2 class="gerstner text-2xl font-medium mb-4">Analyzing Reddit discussions...</h2>
                <p class="text-gray-600 max-w-md mx-auto">
                    Our AI is searching through thousands of Reddit comments to find the most compelling
                    counter-arguments. This may take up to 10 minutes.
                </p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="text-center py-16 hidden">
                <div
                    class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                            clip-rule="evenodd" />
                    </svg>
                </div>
                <h2 class="gerstner text-2xl font-medium mb-4">Oops! Something went wrong</h2>
                <p class="text-gray-600 mb-6" id="error-message"></p>
                <a href="/" class="bg-black text-white px-6 py-2 font-medium hover:bg-gray-800 transition-colors">
                    Try Another Debate
                </a>
            </div>

            <!-- Results State -->
            <div id="results-state" class="hidden">


                <!-- Roast Section -->
                <div class="neural-bg p-8 rounded-lg mb-12">
                    <h2 class="gerstner text-3xl font-medium mb-6 text-center">
                        üî• The Roast
                    </h2>
                    <blockquote class="text-xl italic text-center font-medium" id="roast-content">
                        <!-- Roast will be injected here -->
                    </blockquote>
                </div>

                <!-- Counter-arguments Section -->
                <div>
                    <h2 class="gerstner text-3xl font-medium mb-8 text-center">
                        Counter-Arguments from Reddit
                    </h2>

                    <div class="space-y-6" id="counterpoints-container">
                        <!-- Counterpoints will be injected here -->
                    </div>

                    <!-- Sources Section -->
                    <div class="sources-section" id="sources-section" style="display: none;">
                        <h3 class="gerstner text-xl font-medium mb-4">Sources</h3>
                        <div id="sources-list">
                            <!-- Sources will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- MCP Stats Section -->
                <div id="mcp-stats-section" class="mcp-stats p-6 rounded-lg my-8 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="gerstner text-lg font-medium flex items-center gap-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" />
                            </svg>
                            Analysis Details
                        </h3>
                        <div class="mcp-badge" id="mcp-count-badge">
                            <!-- MCP tool call count will be injected here -->
                        </div>
                    </div>

                    <div class="text-sm text-gray-600 mb-4">
                        Our AI made the following tool calls to gather data from Reddit:
                    </div>

                    <div id="mcp-tool-calls-list">
                        <!-- MCP tool calls will be injected here -->
                    </div>
                </div>

                <!-- Share Section -->
                <div class="text-center mt-16 py-12 border-t border-gray-200">
                    <h3 class="gerstner text-2xl font-medium mb-6">Ready for your own debate?</h3>
                    <a href="/" class="bg-black text-white px-8 py-3 font-medium hover:bg-gray-800 transition-colors">
                        Challenge Another Opinion
                    </a>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="py-8 px-6 border-t border-gray-200">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <img src="https://assets.p0web.com/dark-parallel-logo-270.svg" alt="Parallel" class="w-20 h-auto">
                <span class="text-sm text-gray-600">Powered by Reddit & AI</span>
            </div>
            <div class="text-sm text-gray-600">
                Built for open minds
            </div>
        </div>
    </footer>

    <script>
        // Get data injected from server
        const data = window.data;
        const task = data.task;

        // Populate basic info
        document.getElementById('meme-statement').textContent = task.statement;
        document.getElementById('author-avatar').src = task.profile_image_url || '/default-avatar.png';
        document.getElementById('author-name').textContent = '@' + task.username;

        const date = new Date(task.created_at);
        document.getElementById('debate-date').textContent = date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Show appropriate state
        if (task.status === 'pending') {
            document.getElementById('loading-state').classList.remove('hidden');

            // Store initial page content for comparison
            let initialContent = null;

            // Get initial content
            fetch(window.location.href)
                .then(response => response.text())
                .then(content => {
                    initialContent = content;
                })
                .catch(error => {
                    console.error('Error fetching initial content:', error);
                });

            // Poll for updates every 5 seconds
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(window.location.href);
                    if (response.ok) {
                        const currentContent = await response.text();

                        // If content has changed from initial, refresh the page
                        if (initialContent && currentContent !== initialContent) {
                            clearInterval(pollInterval);
                            window.location.reload();
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 5000);

            // Stop polling after 15 minutes
            setTimeout(() => {
                clearInterval(pollInterval);
            }, 15 * 60 * 1000);

        } else if (task.error) {
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('error-message').textContent = task.error;

        } else if (task.result) {
            document.getElementById('results-state').classList.remove('hidden');

            // Get the output from the task result
            const output = task.result.output;
            const basis = output.basis || [];
            const mcpToolCalls = output.mcp_tool_calls || [];

            // Show MCP stats if there are tool calls
            if (mcpToolCalls.length > 0) {
                document.getElementById('mcp-stats-section').classList.remove('hidden');

                // Update MCP count badge
                const countBadge = document.getElementById('mcp-count-badge');
                countBadge.innerHTML = `
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                    </svg>
                    ${mcpToolCalls.length} tool call${mcpToolCalls.length !== 1 ? 's' : ''}
                `;

                // Populate MCP tool calls list
                const mcpList = document.getElementById('mcp-tool-calls-list');
                mcpToolCalls.forEach((toolCall, index) => {
                    const toolCallDiv = document.createElement('div');
                    toolCallDiv.className = 'tool-call-item';

                    // Parse arguments to show cleaner display
                    let parsedArgs = '';
                    try {
                        const args = JSON.parse(toolCall.arguments);
                        parsedArgs = Object.entries(args)
                            .map(([key, value]) => `${key}: ${value}`)
                            .join(', ');
                    } catch (e) {
                        parsedArgs = toolCall.arguments;
                    }

                    // Truncate content for display
                    let displayContent = toolCall.content || 'No content returned';
                    if (displayContent.length > 150) {
                        displayContent = displayContent.substring(0, 150) + '...';
                    }

                    toolCallDiv.innerHTML = `
                        <div class="tool-call-header">
                            <span class="tool-name">${toolCall.tool_name}</span>
                            <span class="server-name">via ${toolCall.server_name}</span>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">
                            ${parsedArgs}
                        </div>
                        ${toolCall.error ? `
                            <div class="text-xs text-red-600 bg-red-50 p-2 rounded">
                                Error: ${toolCall.error}
                            </div>
                        ` : `
                            <div class="tool-content">
                                ${displayContent}
                            </div>
                        `}
                    `;

                    mcpList.appendChild(toolCallDiv);
                });
            }

            // Collect all unique citations
            const allCitations = [];
            const citationMap = new Map();
            let citationCounter = 1;

            basis.forEach(fieldBasis => {
                if (fieldBasis.citations && fieldBasis.citations.length > 0) {
                    fieldBasis.citations.forEach(citation => {
                        if (!citationMap.has(citation.url)) {
                            const citationWithNumber = {
                                ...citation,
                                number: citationCounter++
                            };
                            allCitations.push(citationWithNumber);
                            citationMap.set(citation.url, citationWithNumber);
                        }
                    });
                }
            });

            // Function to add citation links to text
            function addCitationLinks(text, fieldName) {
                let result = text;
                const fieldBasis = basis.find(b => b.field === fieldName);

                if (fieldBasis && fieldBasis.citations && fieldBasis.citations.length > 0) {
                    fieldBasis.citations.forEach(citation => {
                        const citationInfo = citationMap.get(citation.url);
                        if (citationInfo) {
                            result += `<a href="${citation.url}" target="_blank" rel="noopener noreferrer" class="citation-icon" title="${citation.title || citation.url}">${citationInfo.number}</a>`;
                        }
                    });
                }

                return result;
            }

            // Populate roast with citations
            const roastWithCitations = addCitationLinks(output.content.roast, 'roast');
            document.getElementById('roast-content').innerHTML = roastWithCitations;

            // Populate counterpoints with citations
            const container = document.getElementById('counterpoints-container');
            output.content.counterpoints.forEach((counterpoint, index) => {
                const counterpointWithCitations = addCitationLinks(counterpoint, 'counterpoints');

                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-lg border border-gray-200 shadow-sm';
                card.innerHTML = `
                    <div class="flex items-start space-x-4">
                        <div class="w-8 h-8 bg-black text-white rounded-full flex items-center justify-center font-bold text-sm flex-shrink-0">
                            ${index + 1}
                        </div>
                        <div class="flex-1">
                            <p class="text-gray-900 leading-relaxed">${counterpointWithCitations}</p>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            // Populate sources section if there are citations
            if (allCitations.length > 0) {
                document.getElementById('sources-section').style.display = 'block';
                const sourcesList = document.getElementById('sources-list');

                allCitations.forEach(citation => {
                    const sourceItem = document.createElement('div');
                    sourceItem.className = 'source-item';

                    let excerpts = '';
                    if (citation.excerpts && citation.excerpts.length > 0) {
                        excerpts = citation.excerpts.map(excerpt =>
                            `<div class="excerpt">"${excerpt}"</div>`
                        ).join('');
                    }

                    sourceItem.innerHTML = `
                        <div class="source-number">${citation.number}</div>
                        <div class="flex-1">
                            <a href="${citation.url}" target="_blank" rel="noopener noreferrer" class="source-link">
                                ${citation.title || citation.url}
                            </a>
                            ${excerpts}
                        </div>
                    `;

                    sourcesList.appendChild(sourceItem);
                });
            }
        }
    </script>
</body>

</html>