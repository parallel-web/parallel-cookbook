<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parallel + Groq</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @font-face {
            font-family: 'FT System Mono';
            src: url('https://assets.p0web.com/FTSystemMono-Regular.woff2') format('woff2');
            font-weight: 400;
            font-display: swap;
        }

        @font-face {
            font-family: 'FT System Mono';
            src: url('https://assets.p0web.com/FTSystemMono-Medium.woff2') format('woff2');
            font-weight: 500;
            font-display: swap;
        }

        @font-face {
            font-family: 'Gerstner Programm';
            src: url('https://assets.p0web.com/Gerstner-ProgrammRegular.woff2') format('woff2');
            font-weight: 400;
            font-display: swap;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #fcfcfa;
            color: #1d1b16;
            line-height: 1.6;
        }

        .heading-font {
            font-family: 'Gerstner Programm', serif;
        }

        .search-result {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tool-call {
            background: #f8f8f6;
            border: 1px solid #e5e3dc;
            border-left: 3px solid #d8d0bf;
        }

        .reasoning-section {
            background: #f8f8f6;
            border: 1px solid #e5e3dc;
            border-left: 3px solid #d8d0bf;
            font-size: 0.875rem;
        }

        .reasoning-section .markdown-content {
            font-size: 0.875rem;
            color: #6b645a;
            line-height: 1.6;
        }

        .loading-dots {
            animation: pulse 1.5s ease-in-out infinite;
        }

        .spinner {
            border: 2px solid #e5e3dc;
            border-top: 2px solid #1d1b16;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Typing indicator styles */
        .typing-indicator {
            background: #f1f0ec;
            border: 1px solid #e5e3dc;
            border-left: 3px solid #9e9589;
            animation: fadeIn 0.3s ease-in-out;
        }

        .typing-dots {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 0.375rem;
            height: 0.375rem;
            background-color: #9e9589;
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {

            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: 0.4;
            }

            30% {
                transform: translateY(-0.5rem);
                opacity: 1;
            }
        }

        /* Pulsing indicator for tool calls */
        .tool-loading {
            animation: toolPulse 2s ease-in-out infinite;
        }

        @keyframes toolPulse {

            0%,
            100% {
                opacity: 0.8;
            }

            50% {
                opacity: 1;
                background-color: #f5f4f0;
            }
        }

        /* Update the existing .markdown-content styles with these additions/changes */

        .markdown-content {
            line-height: 1.6;
            overflow-x: auto;
            padding-right: 8px;
            word-wrap: break-word;
            color: #1d1b16;
        }

        /* Improve list rendering */
        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 1em;
            padding-left: 1.5em;
            list-style-position: outside;
        }

        /* Ensure list items have proper styling */
        .markdown-content ul {
            list-style-type: disc;
        }

        .markdown-content ol {
            list-style-type: decimal;
        }

        .markdown-content li {
            margin-bottom: 0.5em;
            display: list-item;
            line-height: 1.5;
        }

        /* Nested lists */
        .markdown-content ul ul,
        .markdown-content ol ol,
        .markdown-content ul ol,
        .markdown-content ol ul {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            padding-left: 1.2em;
        }

        .markdown-content ul ul {
            list-style-type: circle;
        }

        .markdown-content ul ul ul {
            list-style-type: square;
        }

        /* Ensure proper spacing around lists */
        .markdown-content p+ul,
        .markdown-content p+ol {
            margin-top: -0.5em;
        }

        .markdown-content ul+p,
        .markdown-content ol+p {
            margin-top: 0.5em;
        }

        /* Handle list items with paragraphs */
        .markdown-content li p {
            margin-bottom: 0.5em;
        }

        .markdown-content li p:last-child {
            margin-bottom: 0;
        }

        /* Custom scrollbar for markdown content */
        .markdown-content::-webkit-scrollbar {
            width: 6px;
        }

        .markdown-content::-webkit-scrollbar-track {
            background: #f1f0ec;
            border-radius: 3px;
        }

        .markdown-content::-webkit-scrollbar-thumb {
            background: #d8d0bf;
            border-radius: 3px;
        }

        .markdown-content::-webkit-scrollbar-thumb:hover {
            background: #fb631b;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
            color: #1d1b16;
        }

        .markdown-content h1 {
            font-size: 1.5em;
        }

        .markdown-content h2 {
            font-size: 1.3em;
        }

        .markdown-content h3 {
            font-size: 1.1em;
        }

        .markdown-content p {
            margin-bottom: 1em;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 1em;
            padding-left: 1.5em;
        }

        .markdown-content li {
            margin-bottom: 0.25em;
        }

        .markdown-content blockquote {
            border-left: 3px solid #d8d0bf;
            padding-left: 1em;
            margin: 1em 0;
            font-style: italic;
            color: #6b645a;
            background: #f8f8f6;
            border-radius: 0 0.25rem 0.25rem 0;
        }

        .markdown-content code {
            background-color: #f5f4f0;
            color: #3b352c;
            padding: 0.125em 0.25em;
            border-radius: 0.25em;
            font-family: 'FT System Mono', 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.875em;
            border: 1px solid #e5e3dc;
        }

        .markdown-content pre {
            background-color: #f5f4f0;
            padding: 1em;
            border-radius: 0.375em;
            overflow-x: auto;
            margin: 1em 0;
            border: 1px solid #e5e3dc;
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
        }

        .markdown-content a {
            color: #fb631b;
            text-decoration: underline;
            transition: color 0.2s ease;
        }

        .markdown-content a:hover {
            color: #e55a17;
        }

        .markdown-content strong {
            font-weight: 600;
            color: #1d1b16;
        }

        .finish-indicator {
            background: #f0f8f0;
            border: 1px solid #d1e7dd;
            border-left: 3px solid #22c55e;
        }

        /* Mobile-first responsive design */
        @media (max-width: 640px) {
            .container {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }

            .search-input-container {
                padding: 0.75rem;
            }

            .search-btn {
                right: 0.5rem;
                top: 0.5rem;
                bottom: 0.5rem;
                padding-left: 0.75rem;
                padding-right: 0.75rem;
                font-size: 0.875rem;
            }
        }

        /* Light mode specific styles */
        .bg-light-surface {
            background-color: #f8f8f6;
        }

        .border-light {
            border-color: #e5e3dc;
        }

        .text-light-secondary {
            color: #6b645a;
        }

        .text-light-muted {
            color: #9e9589;
        }

        .hover-light-surface:hover {
            background-color: #f1f0ec;
        }
    </style>
</head>

<body class="min-h-screen">
    <div id="app" class="container mx-auto px-2 sm:px-4 py-4 sm:py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8 sm:mb-12">
            <img src="https://assets.p0web.com/dark-parallel-symbol-270.svg" alt="Parallel"
                class="mx-auto mb-4 w-12 h-12 sm:w-16 sm:h-16">
            <h1 class="heading-font text-2xl sm:text-4xl font-bold mb-2">Web Search Agent</h1>
            <p class="text-light-secondary text-sm sm:text-base">Powered by Parallel Search API & Groq AI</p>
        </div>

        <!-- Search Interface -->
        <div id="search-interface" class="space-y-4 sm:space-y-6">
            <div
                class="relative flex flex-row items-center gap-3 pr-2 search-input-container bg-light-surface border border-light rounded-md focus-within:border-neutral-400 transition-all duration-200 hover-light-surface">
                <input type="text" id="search-input" placeholder="What would you like to know?"
                    class="w-full lg:px-4 sm:px-5 py-3 sm:py-4 text-sm lg:text-base bg-transparent focus:outline-none text-black placeholder-neutral-500">
                <button id="search-btn"
                    class="search-btn h-10 px-4 sm:px-5 bg-black text-white rounded hover:bg-neutral-800 transition-all duration-200 font-medium text-sm sm:text-base">
                    Search
                </button>
            </div>

            <div class="flex justify-center">
                <button id="config-btn"
                    class="text-xs sm:text-sm text-light-muted hover:text-light-secondary transition-colors duration-200">
                    Configure System Prompt
                </button>
            </div>

        </div>

        <!-- Results Interface -->
        <div id="results-interface" class="hidden">
            <div class="flex items-center justify-between mb-6 sm:mb-8">
                <h2 class="text-xl sm:text-2xl font-semibold text-black">Search Results</h2>
                <button id="new-search-btn"
                    class="px-4 py-2 bg-light-surface text-black rounded border border-light hover-light-surface hover:border-neutral-400 transition-all duration-200 text-sm font-medium">
                    New Search
                </button>
            </div>

            <div id="results-content" class="space-y-4 sm:space-y-6">
                <!-- Results will be populated here -->
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="hidden text-center py-12 sm:py-16">
            <div class="spinner w-7 h-7 sm:w-9 sm:h-9 mx-auto mb-6"></div>
            <p class="text-light-secondary text-sm sm:text-base font-medium">Researching your query...</p>
        </div>

        <!-- Footer -->
        <footer class="mt-16 sm:mt-20 pt-8 sm:pt-10 border-t border-light text-center">
            <div
                class="flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-4 text-xs sm:text-sm text-light-secondary">
                <span>Built with Groq AI & Parallel Search API</span>
            </div>
            <div class="flex mt-4 justify-center text-xs text-center">
                <p class="text-light-muted">Free demo with rate limits • Self-host for production use</p>
            </div>
        </footer>
    </div>

    <!-- Config Modal -->
    <div id="config-modal" class="hidden fixed inset-0 bg-black/30 flex items-center justify-center p-4 sm:p-6 z-50">
        <div class="bg-light-surface border border-light rounded p-6 sm:p-8 max-w-2xl w-full max-h-[90vh]">
            <h3 class="text-lg sm:text-xl font-semibold mb-6 text-black">System Prompt Configuration</h3>
            <textarea id="system-prompt"
                class="w-full h-32 sm:h-48 p-4 border border-light bg-white rounded resize-none focus:border-neutral-400 focus:outline-none text-sm sm:text-base text-black placeholder-neutral-500 transition-colors duration-200"
                placeholder="Enter custom system prompt..."></textarea>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancel-config"
                    class="px-4 py-2 bg-light-surface text-black rounded hover-light-surface transition-all duration-200 text-sm font-medium border border-light">
                    Cancel
                </button>
                <button id="save-config"
                    class="px-4 py-2 bg-black text-white rounded hover:bg-neutral-800 transition-all duration-200 text-sm font-medium">
                    Save
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentSystemPrompt = '';
        let abortController = null;
        let currentMode = 'text'; // 'text' or 'reasoning'

        // DOM Elements
        const searchInterface = document.getElementById('search-interface');
        const resultsInterface = document.getElementById('results-interface');
        const loadingState = document.getElementById('loading-state');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const newSearchBtn = document.getElementById('new-search-btn');
        const resultsContent = document.getElementById('results-content');
        const configModal = document.getElementById('config-modal');
        const configBtn = document.getElementById('config-btn');
        const systemPromptTextarea = document.getElementById('system-prompt');
        const saveConfigBtn = document.getElementById('save-config');
        const cancelConfigBtn = document.getElementById('cancel-config');

        // Configure marked options
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // Event Listeners
        searchBtn.addEventListener('click', startResearch);
        newSearchBtn.addEventListener('click', showSearchInterface);
        configBtn.addEventListener('click', showConfigModal);
        saveConfigBtn.addEventListener('click', saveConfig);
        cancelConfigBtn.addEventListener('click', hideConfigModal);

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startResearch();
        });

        // Functions
        function showSearchInterface() {
            searchInterface.classList.remove('hidden');
            resultsInterface.classList.add('hidden');
            loadingState.classList.add('hidden');
            resultsContent.innerHTML = '';
            currentMode = 'text';
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
        }

        function showLoadingState() {
            searchInterface.classList.add('hidden');
            resultsInterface.classList.add('hidden');
            loadingState.classList.remove('hidden');
        }

        function showResults() {
            searchInterface.classList.add('hidden');
            resultsInterface.classList.remove('hidden');
            loadingState.classList.add('hidden');
        }

        function showConfigModal() {
            systemPromptTextarea.value = currentSystemPrompt;
            configModal.classList.remove('hidden');
        }

        function hideConfigModal() {
            configModal.classList.add('hidden');
        }

        function saveConfig() {
            currentSystemPrompt = systemPromptTextarea.value;
            hideConfigModal();
        }

        // Loading indicator management
        function addLoadingIndicator(type = 'text') {
            removeLoadingIndicator(); // Remove any existing loading indicator

            const loadingElement = document.createElement('div');
            loadingElement.id = 'active-loading-indicator';

            if (type === 'text') {
                loadingElement.className = 'typing-indicator p-3 sm:p-4 rounded mb-4 search-result';
                loadingElement.innerHTML = `
                    <div class="flex items-center text-sm text-light-secondary">
                        <span class="mr-2">💭 AI is thinking</span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                `;
            } else if (type === 'reasoning') {
                loadingElement.className = 'typing-indicator p-3 sm:p-4 rounded mb-4 search-result';
                loadingElement.innerHTML = `
                    <div class="flex items-center text-sm text-light-secondary">
                        <span class="mr-2">🧠 AI is reasoning</span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                `;
            } else if (type === 'tool') {
                loadingElement.className = 'typing-indicator p-3 sm:p-4 rounded mb-4 search-result';
                loadingElement.innerHTML = `
                    <div class="flex items-center text-sm text-light-secondary">
                        <span class="mr-2">🔍 Searching web sources</span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                `;
            }

            resultsContent.appendChild(loadingElement);
        }

        function removeLoadingIndicator() {
            const existingIndicator = document.getElementById('active-loading-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
        }

        function addToolLoadingAnimation(toolElement) {
            const statusDot = toolElement.querySelector('.w-3.h-3');
            if (statusDot) {
                statusDot.classList.add('animate-pulse');
                statusDot.style.backgroundColor = '#fb631b'; // Orange color
            }
            toolElement.classList.add('tool-loading');
        }

        function removeToolLoadingAnimation(toolElement) {
            const statusDot = toolElement.querySelector('.w-3.h-3');
            if (statusDot) {
                statusDot.classList.remove('animate-pulse');
                statusDot.style.backgroundColor = '#9e9589'; // Back to neutral
            }
            toolElement.classList.remove('tool-loading');
        }

        async function startResearch() {
            const query = searchInput.value.trim();
            if (!query) return;

            showLoadingState();
            currentMode = 'text';

            // Abort any existing request
            if (abortController) {
                abortController.abort();
            }

            abortController = new AbortController();

            try {
                const response = await fetch('/agents/groq-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        systemPrompt: currentSystemPrompt || undefined,
                    }),
                    signal: abortController.signal,
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${await response.text()}`);
                }

                const reader = response.body?.getReader();
                const decoder = new TextDecoder();

                if (!reader) {
                    throw new Error('No response body');
                }

                let buffer = '';
                showResults(); // Show results interface when stream starts
                addLoadingIndicator('text'); // Start with text loading indicator

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });

                    // Process complete lines
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep the last incomplete line in buffer

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                removeLoadingIndicator();
                                return;
                            }

                            try {
                                const chunk = JSON.parse(data);
                                handleStreamChunk(chunk);
                            } catch (error) {
                                console.error('Error parsing chunk:', error, data);
                            }
                        }
                    }
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Request was aborted');
                } else {
                    console.error('Research error:', error);
                    showError(`Research failed: ${error.message}`);
                }
                removeLoadingIndicator();
            } finally {
                abortController = null;
            }
        }

        function handleStreamChunk(chunk) {
            switch (chunk.type) {
                case 'text-delta':
                    if (currentMode === 'reasoning') {
                        finalizeCurrentSection();
                        currentMode = 'text';
                    }
                    removeLoadingIndicator(); // Remove loading when content starts
                    appendText(chunk.text || '');
                    break;
                case 'reasoning-delta':
                    if (currentMode === 'text') {
                        finalizeCurrentSection();
                        currentMode = 'reasoning';
                    }
                    removeLoadingIndicator(); // Remove loading when content starts
                    appendReasoning(chunk.text || '');
                    break;
                case 'tool-call':
                    finalizeCurrentSection();
                    removeLoadingIndicator();
                    const toolElement = addToolCall(chunk);
                    addToolLoadingAnimation(toolElement);
                    addLoadingIndicator('tool');
                    break;
                case 'tool-result':
                    removeLoadingIndicator();
                    // Remove tool loading animation from the last tool call
                    const lastToolCall = resultsContent.querySelector('.tool-call:last-of-type');
                    if (lastToolCall) {
                        removeToolLoadingAnimation(lastToolCall);
                    }
                    addToolResult(chunk);
                    // Add text loading indicator after tool result
                    addLoadingIndicator('text');
                    break;
                case 'error':
                    removeLoadingIndicator();
                    showError(chunk.error?.message || chunk.error?.lastError?.data?.message || 'Unknown error occurred');
                    break;
                case 'finish':
                    finalizeCurrentSection();
                    removeLoadingIndicator();
                    addFinishIndicator(chunk.finishReason);
                    console.log('Research completed with reason:', chunk.finishReason);
                    break;
            }
        }

        function appendText(text) {
            if (!text) return;

            let currentElement = resultsContent.querySelector('.current-text');
            if (!currentElement) {
                currentElement = document.createElement('div');
                currentElement.className = 'current-text bg-light-surface border border-light rounded p-4 sm:p-5 mb-4 search-result';

                // Create the markdown content container
                const markdownContainer = document.createElement('div');
                markdownContainer.className = 'markdown-content';
                currentElement.appendChild(markdownContainer);

                resultsContent.appendChild(currentElement);
            }

            // Store the raw text
            if (!currentElement.rawText) {
                currentElement.rawText = '';
            }
            currentElement.rawText += text;

            // Render markdown
            const textContainer = currentElement.querySelector('.markdown-content');
            if (textContainer) {
                textContainer.innerHTML = marked.parse(currentElement.rawText);
            }
        }

        function appendReasoning(text) {
            if (!text) return;

            let currentElement = resultsContent.querySelector('.current-reasoning');
            if (!currentElement) {
                currentElement = document.createElement('div');
                currentElement.className = 'current-reasoning reasoning-section p-4 sm:p-5 rounded mb-4 search-result';

                // Add reasoning header
                const header = document.createElement('div');
                header.className = 'flex items-center mb-2';
                header.innerHTML = `
                    <div class="w-3 h-3 bg-neutral-400 rounded-full mr-2"></div>
                    <span class="font-medium text-xs sm:text-sm text-light-secondary">🧠 AI Reasoning</span>
                `;
                currentElement.appendChild(header);

                // Create the markdown content container
                const markdownContainer = document.createElement('div');
                markdownContainer.className = 'markdown-content';
                currentElement.appendChild(markdownContainer);

                resultsContent.appendChild(currentElement);
            }

            // Store the raw text
            if (!currentElement.rawText) {
                currentElement.rawText = '';
            }
            currentElement.rawText += text;

            // Render markdown
            const textContainer = currentElement.querySelector('.markdown-content');
            if (textContainer) {
                textContainer.innerHTML = marked.parse(currentElement.rawText);
            }
        }

        function finalizeCurrentSection() {
            const currentTextElement = resultsContent.querySelector('.current-text');
            if (currentTextElement) {
                currentTextElement.classList.remove('current-text');
            }

            const currentReasoningElement = resultsContent.querySelector('.current-reasoning');
            if (currentReasoningElement) {
                currentReasoningElement.classList.remove('current-reasoning');
            }
        }

        function addToolCall(toolCall) {
            finalizeCurrentSection();

            const toolCallElement = document.createElement('div');
            toolCallElement.className = 'tool-call p-4 sm:p-5 rounded mb-4 search-result';

            const objective = toolCall.args?.objective || toolCall.input?.objective || 'Searching...';
            const searchQueries = toolCall.args?.search_queries || toolCall.input?.search_queries || [];

            toolCallElement.innerHTML = `
                <div class="flex items-center mb-2">
                    <div class="w-3 h-3 bg-neutral-400 rounded-full mr-2"></div>
                    <span class="font-medium text-sm sm:text-base">🔍 Searching Web</span>
                </div>
                <div class="text-xs sm:text-sm text-light-secondary">
                    <div class="mb-1"><strong>Objective:</strong> ${objective}</div>
                    ${searchQueries.length > 0 ? `<div><strong>Queries:</strong> ${searchQueries.join(', ')}</div>` : ''}
                </div>
            `;
            resultsContent.appendChild(toolCallElement);
            return toolCallElement;
        }

        /**
         * Creates a URL with text fragments that will highlight the excerpts when clicked
         * @param {string} originalUrl - The original URL
         * @param {string[]} excerpts - Array of text excerpts to highlight
         * @returns {string} URL with text fragments for highlighting
         */
        function createHighlightUrl(originalUrl, excerpts) {
            if (!excerpts || !Array.isArray(excerpts) || excerpts.length === 0) {
                return originalUrl;
            }

            // Clean and prepare excerpts
            const textFragments = excerpts
                .map(excerpt => {
                    if (typeof excerpt !== 'string') return '';

                    // Remove trailing ".." or "..." and trim whitespace
                    return excerpt.replace(/\.{2,}$/, '').trim();
                })
                .filter(excerpt => excerpt.length > 0)
                .map(encodeURIComponent); // Remove empty excerpts

            if (textFragments.length === 0) {
                return originalUrl;
            }

            // Create the text fragment parameter
            const fragmentParam = textFragments.map(fragment => `text=${fragment}`).join('&');

            // Add text fragments to URL
            const separator = originalUrl.includes('#') ? '&' : '#:~:';
            return `${originalUrl}${separator}${fragmentParam}`;
        }

        function addToolResult(toolResult) {
            const results = toolResult?.output?.results;
            if (!results) {
                return;
            }

            const resultElement = document.createElement('div');
            resultElement.className = 'bg-light-surface border border-light rounded p-4 sm:p-5 mb-4 search-result';

            // Count total excerpts
            const totalExcerpts = results.slice(0, 5).reduce((sum, result) => sum + (result.excerpts?.length || 0), 0);

            let resultsHtml = `
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center font-medium text-xs sm:text-sm">
                <div class="w-2 h-2 bg-neutral-400 rounded-full mr-2"></div>
                Search Results Found
            </div>
            ${totalExcerpts > 0 ? `
                <button class="excerpts-toggle-btn text-xs text-light-muted hover:text-light-secondary underline" data-expanded="false">
                    Show Chosen Excerpts (${totalExcerpts})
                </button>
            ` : ''}
        </div>
    `;

            if (results && Array.isArray(results)) {
                const lastIndex = results.slice(0, 5).length - 1;
                results.slice(0, 5).forEach((result, index) => {
                    const notLast = index < lastIndex;
                    const urlWithTextHighlights = createHighlightUrl(result.url, result.excerpts || []);
                    const hasExcerpts = result.excerpts && result.excerpts.length > 0;

                    resultsHtml += `
                <div class="mb-3 pb-3 ${notLast ? 'border-b border-light' : ''}" data-result-index="${index}">
                    <div class="font-medium text-black mb-1">
                        <a href="${urlWithTextHighlights}" target="_blank" class="hover:underline text-xs sm:text-sm hover:text-neutral-700">${escapeHtml(result.title)}</a>
                    </div>
                    <div class="text-xs text-light-muted truncate mb-2">${escapeHtml(result.url)}</div>
                    ${hasExcerpts ? `
                        <div class="excerpts-container hidden">
                            <div class="text-xs font-medium text-light-secondary mb-1">Excerpts:</div>
                            <div class="space-y-1">
                                ${result.excerpts.map(excerpt => `<pre class="text-xs text-black bg-white p-2 rounded border-l-2 border-neutral-300 whitespace-pre-wrap break-words">${escapeHtml(excerpt)}</pre>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
                });

                if (results.length > 5) {
                    resultsHtml += `<div class="text-xs text-light-muted text-center pt-2">+ ${results.length - 5} more results</div>`;
                }
            } else {
                resultsHtml += '<div class="text-xs sm:text-sm text-light-muted">No detailed results available</div>';
            }

            resultElement.innerHTML = resultsHtml;

            // Add event listener for the toggle button
            const toggleBtn = resultElement.querySelector('.excerpts-toggle-btn');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function () {
                    const isExpanded = this.dataset.expanded === 'true';
                    const excerptContainers = resultElement.querySelectorAll('.excerpts-container');

                    if (isExpanded) {
                        // Hide excerpts
                        excerptContainers.forEach(container => container.classList.add('hidden'));
                        this.textContent = `Show Chosen Excerpts (${totalExcerpts})`;
                        this.dataset.expanded = 'false';
                    } else {
                        // Show excerpts
                        excerptContainers.forEach(container => container.classList.remove('hidden'));
                        this.textContent = `Hide Excerpts`;
                        this.dataset.expanded = 'true';
                    }
                });
            }

            resultsContent.appendChild(resultElement);
        }

        // Add this helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';

            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addFinishIndicator(finishReason) {
            const finishElement = document.createElement('div');
            finishElement.className = 'finish-indicator p-4 sm:p-5 rounded mb-4 search-result';

            const reasonText = finishReason || 'completed';
            const reasonDisplay = reasonText.charAt(0).toUpperCase() + reasonText.slice(1);

            finishElement.innerHTML = `
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                    <span class="font-medium text-sm sm:text-base text-black">✅ Research Complete</span>
                    <span class="ml-2 text-xs text-light-secondary">• ${reasonDisplay}</span>
                </div>
            `;
            resultsContent.appendChild(finishElement);
        }

        function showError(error) {
            showResults(); // Make sure results interface is visible
            finalizeCurrentSection(); // Finalize any current section

            const errorElement = document.createElement('div');
            errorElement.className = 'bg-red-50 border border-red-200 text-red-800 px-4 sm:px-5 py-4 rounded mb-4 search-result';
            errorElement.innerHTML = `<div class="flex items-center text-sm sm:text-base"><div class="w-3 h-3 bg-red-400 rounded-full mr-3"></div><strong>Error:</strong> ${error}</div>`;
            resultsContent.appendChild(errorElement);
        }

        // Initialize
        showSearchInterface();
    </script>
</body>

</html>