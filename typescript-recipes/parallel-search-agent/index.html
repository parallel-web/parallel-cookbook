<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Research Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @font-face {
            font-family: 'FT System Mono';
            src: url('https://assets.p0web.com/FTSystemMono-Regular.woff2') format('woff2');
            font-weight: 400;
            font-display: swap;
        }

        @font-face {
            font-family: 'FT System Mono';
            src: url('https://assets.p0web.com/FTSystemMono-Medium.woff2') format('woff2');
            font-weight: 500;
            font-display: swap;
        }

        @font-face {
            font-family: 'Gerstner Programm';
            src: url('https://assets.p0web.com/Gerstner-ProgrammRegular.woff2') format('woff2');
            font-weight: 400;
            font-display: swap;
        }

        body {
            font-family: 'FT System Mono', monospace;
            background-color: #fcfcfa;
            color: #1d1b16;
        }

        .heading-font {
            font-family: 'Gerstner Programm', serif;
        }

        .search-result {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tool-call {
            background: linear-gradient(135deg, #fb631b20, #d8d0bf20);
            border-left: 4px solid #fb631b;
        }

        .loading-dots {
            animation: pulse 1.5s ease-in-out infinite;
        }

        .spinner {
            border: 2px solid #d8d0bf;
            border-top: 2px solid #fb631b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Markdown styles */
        .markdown-content {
            line-height: 1.6;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
        }

        .markdown-content h1 {
            font-size: 1.5em;
        }

        .markdown-content h2 {
            font-size: 1.3em;
        }

        .markdown-content h3 {
            font-size: 1.1em;
        }

        .markdown-content p {
            margin-bottom: 1em;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 1em;
            padding-left: 1.5em;
        }

        .markdown-content li {
            margin-bottom: 0.25em;
        }

        .markdown-content blockquote {
            border-left: 4px solid #d8d0bf;
            padding-left: 1em;
            margin: 1em 0;
            font-style: italic;
            color: #666;
        }

        .markdown-content code {
            background-color: #f5f5f5;
            padding: 0.125em 0.25em;
            border-radius: 0.25em;
            font-family: 'FT System Mono', monospace;
            font-size: 0.9em;
        }

        .markdown-content pre {
            background-color: #f5f5f5;
            padding: 1em;
            border-radius: 0.5em;
            overflow-x: auto;
            margin: 1em 0;
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
        }

        .markdown-content a {
            color: #fb631b;
            text-decoration: none;
        }

        .markdown-content a:hover {
            text-decoration: underline;
        }

        .markdown-content strong {
            font-weight: 500;
        }
    </style>
</head>

<body class="min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-12">
            <img src="https://assets.p0web.com/dark-parallel-symbol-270.svg" alt="Parallel"
                class="mx-auto mb-4 w-16 h-16">
            <h1 class="heading-font text-4xl font-bold mb-2">Web Research Agent</h1>
            <p class="text-gray-600">Powered by Parallel Search API & Cerebras AI</p>
        </div>

        <!-- Search Interface -->
        <div id="search-interface" class="space-y-6">
            <div class="relative">
                <input type="text" id="search-input" placeholder="What would you like to research?"
                    class="w-full px-6 py-4 text-lg border-2 border-gray-200 rounded-lg focus:border-orange-500 focus:outline-none transition-colors bg-white">
                <button id="search-btn"
                    class="absolute right-2 top-2 bottom-2 px-6 bg-orange-500 text-white rounded-md hover:bg-orange-600 transition-colors font-medium">
                    Research
                </button>
            </div>

            <div class="flex justify-center">
                <button id="config-btn" class="text-sm text-gray-500 hover:text-gray-700 underline">
                    Configure System Prompt
                </button>
            </div>
        </div>

        <!-- Results Interface -->
        <div id="results-interface" class="hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Research Results</h2>
                <button id="new-search-btn"
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                    New Search
                </button>
            </div>

            <div id="results-content" class="space-y-6">
                <!-- Results will be populated here -->
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="hidden text-center py-12">
            <div class="spinner w-8 h-8 mx-auto mb-4"></div>
            <p class="text-gray-600">Researching your query...</p>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="config-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-96">
            <h3 class="text-xl font-bold mb-4">System Prompt Configuration</h3>
            <textarea id="system-prompt"
                class="w-full h-48 p-4 border border-gray-200 rounded-lg resize-none focus:border-orange-500 focus:outline-none"
                placeholder="Enter custom system prompt..."></textarea>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancel-config" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                    Cancel
                </button>
                <button id="save-config" class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600">
                    Save
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentSystemPrompt = '';
        let abortController = null;

        // DOM Elements
        const searchInterface = document.getElementById('search-interface');
        const resultsInterface = document.getElementById('results-interface');
        const loadingState = document.getElementById('loading-state');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const newSearchBtn = document.getElementById('new-search-btn');
        const resultsContent = document.getElementById('results-content');
        const configModal = document.getElementById('config-modal');
        const configBtn = document.getElementById('config-btn');
        const systemPromptTextarea = document.getElementById('system-prompt');
        const saveConfigBtn = document.getElementById('save-config');
        const cancelConfigBtn = document.getElementById('cancel-config');

        // Configure marked options
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // Event Listeners
        searchBtn.addEventListener('click', startResearch);
        newSearchBtn.addEventListener('click', showSearchInterface);
        configBtn.addEventListener('click', showConfigModal);
        saveConfigBtn.addEventListener('click', saveConfig);
        cancelConfigBtn.addEventListener('click', hideConfigModal);

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startResearch();
        });

        // Functions
        function showSearchInterface() {
            searchInterface.classList.remove('hidden');
            resultsInterface.classList.add('hidden');
            loadingState.classList.add('hidden');
            resultsContent.innerHTML = '';
            searchInput.value = '';
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
        }

        function showLoadingState() {
            searchInterface.classList.add('hidden');
            resultsInterface.classList.add('hidden');
            loadingState.classList.remove('hidden');
        }

        function showResults() {
            searchInterface.classList.add('hidden');
            resultsInterface.classList.remove('hidden');
            loadingState.classList.add('hidden');
        }

        function showConfigModal() {
            systemPromptTextarea.value = currentSystemPrompt;
            configModal.classList.remove('hidden');
        }

        function hideConfigModal() {
            configModal.classList.add('hidden');
        }

        function saveConfig() {
            currentSystemPrompt = systemPromptTextarea.value;
            hideConfigModal();
        }

        async function startResearch() {
            const query = searchInput.value.trim();
            if (!query) return;

            showLoadingState();

            // Abort any existing request
            if (abortController) {
                abortController.abort();
            }

            abortController = new AbortController();

            try {
                const response = await fetch('/api/research', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        systemPrompt: currentSystemPrompt || undefined,
                    }),
                    signal: abortController.signal,
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body?.getReader();
                const decoder = new TextDecoder();

                if (!reader) {
                    throw new Error('No response body');
                }

                let buffer = '';
                showResults(); // Show results interface when stream starts

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });

                    // Process complete lines
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep the last incomplete line in buffer

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                return;
                            }

                            try {
                                const chunk = JSON.parse(data);
                                handleStreamChunk(chunk);
                            } catch (error) {
                                console.error('Error parsing chunk:', error, data);
                            }
                        }
                    }
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Request was aborted');
                } else {
                    console.error('Research error:', error);
                    showError(`Research failed: ${error.message}`);
                }
            } finally {
                abortController = null;
            }
        }

        function handleStreamChunk(chunk) {
            switch (chunk.type) {
                case 'text-delta':
                    appendText(chunk.text || '');
                    break;
                case 'reasoning-delta':
                    appendText(chunk.text || '');
                    break;
                case 'tool-call':
                    addToolCall(chunk);
                    break;
                case 'tool-result':
                    addToolResult(chunk);
                    break;
                case 'error':
                    showError(chunk.error);
                    break;
                case 'finish':
                    // Research completed - finalize current text element
                    finalizeCurrentText();
                    console.log('Research completed');
                    break;
            }
        }

        function appendText(text) {
            if (!text) return;

            let currentTextElement = resultsContent.querySelector('.current-text');
            if (!currentTextElement) {
                currentTextElement = document.createElement('div');
                currentTextElement.className = 'current-text bg-white border border-gray-200 rounded-lg p-4 mb-4 search-result';

                // Create the markdown content container
                const markdownContainer = document.createElement('div');
                markdownContainer.className = 'markdown-content';
                currentTextElement.appendChild(markdownContainer);

                resultsContent.appendChild(currentTextElement);
            }

            // Store the raw text
            if (!currentTextElement.rawText) {
                currentTextElement.rawText = '';
            }
            currentTextElement.rawText += text;

            // Render markdown
            const textContainer = currentTextElement.querySelector('.markdown-content');
            if (textContainer) {
                textContainer.innerHTML = marked.parse(currentTextElement.rawText);
            }
        }

        function finalizeCurrentText() {
            const currentTextElement = resultsContent.querySelector('.current-text');
            if (currentTextElement) {
                currentTextElement.classList.remove('current-text');
            }
        }

        function addToolCall(toolCall) {
            // Finalize any current text element before adding tool call
            finalizeCurrentText();

            const toolCallElement = document.createElement('div');
            toolCallElement.className = 'tool-call p-4 rounded-lg mb-4 search-result';

            const objective = toolCall.args?.objective || toolCall.input?.objective || 'Searching...';
            const searchQueries = toolCall.args?.search_queries || toolCall.input?.search_queries || [];

            toolCallElement.innerHTML = `
                <div class="flex items-center mb-2">
                    <div class="w-3 h-3 bg-orange-500 rounded-full mr-2 animate-pulse"></div>
                    <span class="font-medium">üîç Searching Web</span>
                </div>
                <div class="text-sm text-gray-600">
                    <div class="mb-1"><strong>Objective:</strong> ${objective}</div>
                    ${searchQueries.length > 0 ? `<div><strong>Queries:</strong> ${searchQueries.join(', ')}</div>` : ''}
                </div>
            `;
            resultsContent.appendChild(toolCallElement);
        }

        function addToolResult(toolResult) {
            const resultElement = document.createElement('div');
            resultElement.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4 search-result';

            let resultsHtml = '<div class="flex items-center font-medium text-sm mb-3"><div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>Search Results Found</div>';

            const output = toolResult.result || toolResult.output;
            if (output && output.results && Array.isArray(output.results)) {
                output.results.slice(0, 5).forEach((result, index) => {
                    resultsHtml += `
                        <div class="mb-3 pb-3 ${index < Math.min(output.results.length, 5) - 1 ? 'border-b border-gray-200' : ''}">
                            <div class="font-medium text-blue-600 mb-1">
                                <a href="${result.url}" target="_blank" class="hover:underline text-sm">${result.title}</a>
                            </div>
                            <div class="text-xs text-gray-500 truncate">${result.url}</div>
                        </div>
                    `;
                });
                if (output.results.length > 5) {
                    resultsHtml += `<div class="text-xs text-gray-500 text-center pt-2">+ ${output.results.length - 5} more results</div>`;
                }
            } else {
                resultsHtml += '<div class="text-sm text-gray-500">No detailed results available</div>';
            }

            resultElement.innerHTML = resultsHtml;
            resultsContent.appendChild(resultElement);
        }

        function showError(error) {
            showResults(); // Make sure results interface is visible
            finalizeCurrentText(); // Finalize any current text

            const errorElement = document.createElement('div');
            errorElement.className = 'bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 search-result';
            errorElement.innerHTML = `<div class="flex items-center"><div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div><strong>Error:</strong> ${error}</div>`;
            resultsContent.appendChild(errorElement);
        }

        // Initialize
        showSearchInterface();
    </script>
</body>

</html>